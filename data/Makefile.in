# -- LICENSE BEGIN --
#
# Copyright (c) 2015-2018, Lawrence Livermore National Security, LLC.
#
# Produced at the Lawrence Livermore National Laboratory
#
# Written by
#   Michael Bentley (mikebentley15@gmail.com),
#   Geof Sawaya (fredricflinstone@gmail.com),
#   and Ian Briggs (ian.briggs@utah.edu)
# under the direction of
#   Ganesh Gopalakrishnan
#   and Dong H. Ahn.
#
# LLNL-CODE-743137
#
# All rights reserved.
#
# This file is part of FLiT. For details, see
#   https://pruners.github.io/flit
# Please also read
#   https://github.com/PRUNERS/FLiT/blob/master/LICENSE
#
# Redistribution and use in source and binary forms, with or
# without modification, are permitted provided that the following
# conditions are met:
#
# - Redistributions of source code must retain the above copyright
#   notice, this list of conditions and the disclaimer below.
#
# - Redistributions in binary form must reproduce the above
#   copyright notice, this list of conditions and the disclaimer
#   (as noted below) in the documentation and/or other materials
#   provided with the distribution.
#
# - Neither the name of the LLNS/LLNL nor the names of its
#   contributors may be used to endorse or promote products derived
#   from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
# CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES,
# INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL LAWRENCE LIVERMORE NATIONAL
# SECURITY, LLC, THE U.S. DEPARTMENT OF ENERGY OR CONTRIBUTORS BE
# LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
# TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
# IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
# THE POSSIBILITY OF SUCH DAMAGE.
#
# Additional BSD Notice
#
# 1. This notice is required to be provided under our contract
#    with the U.S. Department of Energy (DOE). This work was
#    produced at Lawrence Livermore National Laboratory under
#    Contract No. DE-AC52-07NA27344 with the DOE.
#
# 2. Neither the United States Government nor Lawrence Livermore
#    National Security, LLC nor any of their employees, makes any
#    warranty, express or implied, or assumes any liability or
#    responsibility for the accuracy, completeness, or usefulness of
#    any information, apparatus, product, or process disclosed, or
#    represents that its use would not infringe privately-owned
#    rights.
#
# 3. Also, reference herein to any specific commercial products,
#    process, or services by trade name, trademark, manufacturer or
#    otherwise does not necessarily constitute or imply its
#    endorsement, recommendation, or favoring by the United States
#    Government or Lawrence Livermore National Security, LLC. The
#    views and opinions of authors expressed herein do not
#    necessarily state or reflect those of the United States
#    Government or Lawrence Livermore National Security, LLC, and
#    shall not be used for advertising or product endorsement
#    purposes.
#
# -- LICENSE END --
# Autogenerated Makefile using "flit update"
#   flit version {flit_version}

FFLAGS          ?=
DEV_TARGET      ?= devrun
GT_TARGET       ?= gtrun
GT_OUT          := ground-truth.csv

UNAME_S         := $(shell uname -s)

FLIT_INC_DIR    := {flit_include_dir}
FLIT_LIB_DIR    := {flit_lib_dir}
FLIT_DATA_DIR   := {flit_data_dir}
FLIT_SCRIPT_DIR := {flit_script_dir}

DEV_CC          ?= {dev_compiler}
DEV_OPTL        ?= {dev_optl}
DEV_SWITCHES    ?= {dev_switches}

GT_CC           := {ground_truth_compiler}
GT_OPTL         := {ground_truth_optl}
GT_SWITCHES     := {ground_truth_switches}

TEST_RUN_ARGS   := {test_run_args}

ENABLE_MPI      := {enable_mpi}
MPIRUN_ARGS     := {mpirun_args}

# initalize some variables to be appended later
CC_REQUIRED     :=
DEV_CFLAGS      :=
LD_REQUIRED     :=

RUNWRAP          = $(RUN_WRAPPER)
ifeq ($(ENABLE_MPI),yes) # If we are using MPI
  $(info MPI is enabled)
  RUNWRAP       += mpirun $(MPIRUN_ARGS)
  CC_REQUIRED   += -DFLIT_USE_MPI
  CC_REQUIRED   += $(shell mpic++ --showme:compile)
  LD_REQUIRED   += $(shell mpic++ --showme:link)
endif

OBJ_DIR         := obj

CC_REQUIRED     += $(FFLAGS)
# This flag specifies NOT to build position-independent executables
CC_REQUIRED     += -fno-pie
CC_REQUIRED     += -std=c++11
CC_REQUIRED     += -I.
CC_REQUIRED     += -I$(FLIT_INC_DIR)

DEV_CFLAGS      += -g
DEV_CFLAGS      += -Wall
DEV_CFLAGS      += -Wextra
DEV_CFLAGS      += -Wuninitialized
DEV_CFLAGS      += -Wno-shift-count-overflow

# This flag specifies NOT to link as a position-independent executable
# Note: this flag does not exist in GCC 4 or GCC 5 so it will fail to compile
#       we need extra logic to check for this and conditionally add this flag
#LD_REQUIRED     += -no-pie
LD_REQUIRED     += -lm
LD_REQUIRED     += -lstdc++
ifeq ($(UNAME_S),Darwin) # If we are on a Mac OSX system
  LD_REQUIRED   += -Llib -lflit
else
  LD_REQUIRED   += -L$(FLIT_LIB_DIR) -lflit
  LD_REQUIRED   += -Wl,-rpath=$(realpath $(FLIT_LIB_DIR))
endif

# Helper functions to determine if the compiler is a particular version of GCC

# Returns the compiler name as output by the --version flag
# @param 1: executable name or path to compiler
GET_COMPILER     = $(shell $1 --version | head -n 1 | awk '{{ print $$1 }}')

# Returns 1 if the given compiler is GCC, else 0
# @param 1: executable name or path to compiler
IS_GCC           = $(shell expr $(call GET_COMPILER,$(1)) = gcc \| \
                                $(call GET_COMPILER,$1) = g++)

# Returns the version of the compiler as returned by -dumpversion
# @param 1: executable name or path to compiler
GET_COMPILER_VER = $(shell $1 -dumpversion)

# Returns 1 if the major version matches else 0
# @param 1: executable name or path to compiler
# @param 2: major version number as an integer
IS_MAJOR_VER     = $(shell expr substr $(call GET_COMPILER_VER,$1) 1 1 = $2)

# Returns 1 if the compiler is GCC version 4 or version 5
# @param 1: executable name or path to compiler
IS_GCC_4_OR_5    = $(shell expr $(call IS_GCC,$1) \& \
                             \( $(call IS_MAJOR_VER,$1,4) \| \
                                $(call IS_MAJOR_VER,$1,5) \))

DEV_LDFLAGS      =
GT_LDFLAGS       =

DEPFLAGS        += -MMD -MF $(patsubst %.o,%.d,$@)

TESTS            = $(wildcard tests/*.cpp)
SOURCE           = $(wildcard *.cpp)
SOURCE          += $(TESTS)

VPATH            = $(dir $(SOURCE))

.PHONY: help
help:
	@echo 'You can run the Makefile directly, but it is recommended to use'
	@echo
	@echo '  flit make'
	@echo
	@echo 'so that you can have functionality such as adding the results to a'
	@echo 'database.'
	@echo
	@echo 'The following targets are available:'
	@echo
	@echo '  help        Show this help and exit (default target)'
	@echo '  dev         Only run the devel compilation to test things out'
	@echo '  groundtruth Compile the ground-truth version'
	@echo '  gt          Same as groundtruth'
	@echo '  runbuild    Build all executables needed for the run target'
	@echo '  run         Run all combinations of compilation, results in results/'
	@echo '  clean       Clean intermediate files'
	@echo '  veryclean   Runs clean + removes targets and results'
	@echo '  distclean   Same as veryclean'
	@echo

# Note: having this include at the end breaks the makefile for when users add
# to SOURCE from custom.mk
-include custom.mk

# We are done adding to VPATH, so consolidate it for speed (removing duplicates)
VPATH           := $(sort $(VPATH))

DEV_OBJ          = $(addprefix $(OBJ_DIR)/,$(notdir $(SOURCE:%.cpp=%_dev.o)))
DEV_DEPS         = $(DEV_OBJ:%.o=%.d)
GT_OBJ           = $(addprefix $(OBJ_DIR)/,$(notdir $(SOURCE:%.cpp=%_gt.o)))
GT_DEPS          = $(GT_OBJ:%.o=%.d)

CLANG           := clang++
INTEL           := icpc
GCC             := g++

ifdef CLANG_ONLY
COMPILERS       := CLANG
else
COMPILERS       := $(foreach c, GCC INTEL CLANG, \
                     $(if $(shell which $($(c)) 2>/dev/null), $c,))
endif

HOSTNAME        := $(shell hostname)

RESULTS_DIR     := results

# on systems with non-standard gcc installations (such as module), clang may
# be unable to determine the correct gcc toolchain
GCC_TOOLCHAIN   := $(dir $(shell which $(GCC) 2>/dev/null))/..
CLANG_REQUIRED  := --gcc-toolchain=$(GCC_TOOLCHAIN)

# Compiler setting targets
#   taken from: https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html
#   among other places
# more comp settings, taken from here:
# https://software.intel.com/sites/default/files/article/326703/fp-control-2012-08.pdf

#individual flags
## optls

O0              := -O0
O1              := -O1
O2              := -O2
O3              := -O3

#switches

ASSOCMATH       := -fassociative-math
AVX             := -mavx
COMPTRANS       := -mp1
DEFFLAGS        :=
DISFMA          := -no-fma
ENAFMA          := -fma
FASTEXPREC      := -fexcess-precision=fast
FASTM           := -ffast-math
FINMATH         := -ffinite-math-only
FLUSHDEN        := -ftz
FMAGCC          := -mavx2 -mfma
FMAICC          := -march=core-avx2
FORTRULES       := -fcx-fortran-rules
FPCONT          := -ffp-contract=on
FPMODDBL        := -fp-model=double
FPMODEXC        := -fp-model=except
FPMODEXT        := -fp-model=extended
FPMODFST1       := -fp-model fast=1
FPMODFST2       := -fp-model fast=2
FPMODPRE        := -fp-model=precise
FPMODSRC        := -fp-model=source
FPMODSTR        := -fp-model=strict
FPTRAP          := -fp-trap=common
FSTORE          := -ffloat-store
LIMITEDRANGE    := -fcx-limited-range
MCONSTS         := -fmerge-all-constants
NOFLUSHDEN      := -no-ftz
NOPRECDIV       := -no-prec-div
NOTRAP          := -fno-trapping-math
PRECDIV         := -prec-div
RECIPMATH       := -freciprocal-math
ROUNDINGMATH    := -frounding-math
ROUNDUSR        := -fp-port
SIGNALNAN       := -fsignaling-nans
SINGLEPRECCONST := -fsingle-precision-constant
SSE             := -mfpmath=sse -mtune=native
STDEXPREC       := -fexcess-precision=standard
UNSOPTS         := -funsafe-math-optimizations
USEFASTM        := --use_fast_math

# Collections

OPCODES         := O0 O1 O2 O3

# NOTE: gcc disables ASSOCMATH @ O0
SWITCHES_GCC    += ASSOCMATH
SWITCHES_GCC    += AVX
SWITCHES_GCC    += DEFFLAGS
SWITCHES_GCC    += FASTEXPREC
SWITCHES_GCC    += FINMATH
SWITCHES_GCC    += FMAGCC
SWITCHES_GCC    += FORTRULES
SWITCHES_GCC    += FPCONT
SWITCHES_GCC    += FSTORE
SWITCHES_GCC    += LIMITEDRANGE
SWITCHES_GCC    += MCONSTS
SWITCHES_GCC    += NOTRAP
SWITCHES_GCC    += RECIPMATH
SWITCHES_GCC    += ROUNDINGMATH
SWITCHES_GCC    += SIGNALNAN
SWITCHES_GCC    += SSE
SWITCHES_GCC    += UNSOPTS

#NOTE: Clang not honoring ASSOCMATH (issues warning with 3.9)
# see: https://llvm.org/bugs/show_bug.cgi?id=27372

SWITCHES_CLANG  += ASSOCMATH
SWITCHES_CLANG  += AVX
SWITCHES_CLANG  += DEFFLAGS
SWITCHES_CLANG  += FASTEXPREC
SWITCHES_CLANG  += FINMATH
SWITCHES_CLANG  += FMAGCC
SWITCHES_CLANG  += FMAICC
SWITCHES_CLANG  += FPCONT
SWITCHES_CLANG  += FSTORE
SWITCHES_CLANG  += MCONSTS
SWITCHES_CLANG  += NOTRAP
SWITCHES_CLANG  += RECIPMATH
SWITCHES_CLANG  += ROUNDINGMATH
SWITCHES_CLANG  += SIGNALNAN
SWITCHES_CLANG  += SINGLEPRECCONST
SWITCHES_CLANG  += SSE
SWITCHES_CLANG  += STDEXPREC
SWITCHES_CLANG  += UNSOPTS

SWITCHES_INTEL  += AVX
SWITCHES_INTEL  += COMPTRANS
SWITCHES_INTEL  += DEFFLAGS
SWITCHES_INTEL  += DISFMA
SWITCHES_INTEL  += ENAFMA
SWITCHES_INTEL  += FLUSHDEN
SWITCHES_INTEL  += FMAGCC
SWITCHES_INTEL  += FMAICC
SWITCHES_INTEL  += FPMODDBL
SWITCHES_INTEL  += FPMODEXT
SWITCHES_INTEL  += FPMODFST1
SWITCHES_INTEL  += FPMODFST2
SWITCHES_INTEL  += FPMODPRE
SWITCHES_INTEL  += FPMODSRC
SWITCHES_INTEL  += FPMODSTR
SWITCHES_INTEL  += FSTORE
SWITCHES_INTEL  += LIMITEDRANGE
SWITCHES_INTEL  += MCONSTS
SWITCHES_INTEL  += NOFLUSHDEN
SWITCHES_INTEL  += NOPRECDIV
SWITCHES_INTEL  += PRECDIV
SWITCHES_INTEL  += ROUNDINGMATH
SWITCHES_INTEL  += ROUNDUSR
SWITCHES_INTEL  += SINGLEPRECCONST
SWITCHES_INTEL  += SSE
SWITCHES_INTEL  += USEFASTM


##########################################################
#
# Now to define the recursion for speed and memory reasons
#
##########################################################

# will be set internally when doing recursive calls.  Get set to variable names
# containing the information (e.g. R_CUR_COMPILER=CLANG)
R_CUR_COMPILER  ?=
R_CUR_OPTL      ?=
R_CUR_SWITCHES  ?=

# If we are in a recursion
ifdef R_IS_RECURSED

R_ID            := $(R_CUR_COMPILER)_$(HOSTNAME)_$(R_CUR_SWITCHES)_$(R_CUR_OPTL)
R_TARGET        := $(RESULTS_DIR)/$(R_ID)
R_OBJ           := $(addprefix $(OBJ_DIR)/,$(notdir $(SOURCE:%.cpp=%_$(R_ID).o)))
R_DEP           := $(R_OBJ:%.o=%.d)

-include $(R_DEP)

.PHONY: rec
rec: $(R_TARGET)

# if the current compiler is not GCC 4 or 5, then enable -no-pie
ifeq ($(call IS_GCC_4_OR_5,$($(R_CUR_COMPILER))),0)
  LD_REQUIRED += -no-pie
endif

$(R_TARGET): $(R_OBJ)
	$($(R_CUR_COMPILER)) $($(R_CUR_OPTL)) $($(R_CUR_SWITCHES)) \
	  $($(R_CUR_COMPILER)_REQUIRED) $(CC_REQUIRED) \
	  $(R_OBJ) -o $@ \
	  $(LD_REQUIRED)

$(OBJ_DIR)/%_$(R_ID).o: %.cpp Makefile custom.mk | $(OBJ_DIR)
	$($(R_CUR_COMPILER)) $($(R_CUR_OPTL)) $($(R_CUR_SWITCHES)) \
	  -c $($(R_CUR_COMPILER)_REQUIRED) $(CC_REQUIRED) \
	  $< -o $@ \
	  $(DEPFLAGS) \
	  -DFLIT_HOST='"$(HOSTNAME)"' \
	  -DFLIT_COMPILER='"$($(R_CUR_COMPILER))"' \
	  -DFLIT_OPTL='"$($(R_CUR_OPTL))"' \
	  -DFLIT_SWITCHES='"$($(R_CUR_SWITCHES))"' \
	  -DFLIT_FILENAME='"$(R_ID)"'

# Otherwise, we're not in a recursion.
else # ifndef R_IS_RECURSED

# if the dev compiler is not an old version of GCC
ifeq ($(call IS_GCC_4_OR_5,$(DEV_CC)),0)
  DEV_LDFLAGS   += -no-pie
endif

# if the gt compiler is not an old version of GCC
ifeq ($(call IS_GCC_4_OR_5,$(GT_CC)),0)
  GT_LDFLAGS    += -no-pie
endif

$(OBJ_DIR):
	mkdir -p $(OBJ_DIR)
$(RESULTS_DIR):
	mkdir -p $(RESULTS_DIR)

#
# Define the recursion rules
#

# Set these as empty "simply-expanded variables".  This affects the "+=" operator.
# see https://ftp.gnu.org/old-gnu/Manuals/make-3.79.1/html_chapter/make_6.html
TARGET_OUTS     :=

# @param 1: compiler variable name (e.g. CLANG)
# @param 2: optimization level variable name (e.g. O2)
# @param 3: switches variable name (e.g. USEFASTM)
define RECURSION_RULE
TARGETS         += $$(RESULTS_DIR)/$(strip $1)_$$(HOSTNAME)_$(strip $3)_$(strip $2)

# TODO: use the variable $$(MAKECMDGOALS) to get the original make target
# TODO- or see if it is even necessary

# Make the recursive target depend on $$(GT_TARGET), not because it actually
# depends on that target, but we know that when $$(GT_TARGET) needs to be
# rebuilt, so does each recursive target.

$$(RESULTS_DIR)/$(strip $1)_$$(HOSTNAME)_$(strip $3)_$(strip $2): $$(GT_TARGET) | $$(OBJ_DIR) $$(RESULTS_DIR)
	-$$(MAKE) rec \
	  R_IS_RECURSED=True \
	  R_CUR_COMPILER=$(strip $1) \
	  R_CUR_OPTL=$(strip $2) \
	  R_CUR_SWITCHES=$(strip $3)
	-test -f $$(RESULTS_DIR)/$(strip $1)_$$(HOSTNAME)_$(strip $3)_$(strip $2)

endef

$(foreach c, $(COMPILERS),                 \
  $(foreach s, $(SWITCHES_$(strip $c)),    \
    $(foreach o, $(OPCODES),               \
      $(eval $(call RECURSION_RULE, $c, $o, $s)))))
TARGET_OUTS     := $(TARGETS:%=%-out)
TARGET_RESULTS  := $(TARGET_OUTS:%=%-comparison.csv)

%-out: %
	$(RUNWRAP) ./$< $(TEST_RUN_ARGS) --output $@ || touch $@

# specify how to get comparison
%-out-comparison.csv: %-out $(GT_OUT) $(GT_TARGET)
	$(RUNWRAP) ./$(GT_TARGET) --compare-mode --compare-gt $(GT_OUT) --suffix "-comparison.csv" $< -o /dev/null
#$(RESULTS_DIR)/%_out.csv: $(RESULTS_DIR)/%
#	$< --output $@

#
# Define the recursion rules
#

OBJ_CLEAN        = $(addprefix $(OBJ_DIR)/,$(notdir $(SOURCE:%.cpp=%_*.o)))
DEP_CLEAN       += $(OBJ_CLEAN:%.o=%.d)

.PHONY: dev gt groundtruth run runbuild
dev: $(DEV_TARGET)
gt: groundtruth
groundtruth: $(GT_TARGET)

run: $(TARGET_RESULTS) $(TARGET_OUTS)
run: $(GT_OUT)
run: runbuild
runbuild: $(TARGETS) groundtruth

.PHONY: clean
clean:
	@# Here we do it this way because we were running into the error of too many
	@# arguments given to rm.
	$(foreach obj,$(OBJ_CLEAN),rm -f $(obj);)
	$(foreach obj,$(DEP_CLEAN),rm -f $(obj);)
	-rmdir $(OBJ_DIR)

.PHONY: veryclean distclean
veryclean: distclean
distclean: clean
	rm -f $(DEV_TARGET)
	rm -f $(TARGET_OUTS)
	rm -f $(TARGET_RESULTS)
	rm -f $(addsuffix *.dat,$(TARGET_OUTS))
	rm -f $(TARGETS)
	rm -f $(GT_TARGET)
	rm -f $(GT_OUT)
	rm -f $(addsuffix *.dat,$(GT_OUT))
	-rmdir $(RESULTS_DIR)

Makefile: flit-config.toml
Makefile: $(FLIT_DATA_DIR)/Makefile.in
Makefile: $(FLIT_SCRIPT_DIR)/flitconfig.py
Makefile: $(FLIT_SCRIPT_DIR)/flitutil.py
Makefile: $(FLIT_SCRIPT_DIR)/flit_update.py
	$(FLIT_SCRIPT_DIR)/flit.py update


# We have a different solution if we are on a mac
ifeq ($(UNAME_S),Darwin)
lib/libflit.so: $(FLIT_LIB_DIR)/libflit.so
	mkdir -p lib
	cp $< $@

.PHONY: cleanlibflit
distclean: cleanlibflit
cleanlibflit:
	rm -rf lib

$(DEV_TARGET): lib/libflit.so
$(GT_TARGET):  lib/libflit.so
$(TARGETS):    lib/libflit.so
else
$(DEV_TARGET): $(FLIT_LIB_DIR)/libflit.so
$(GT_TARGET):  $(FLIT_LIB_DIR)/libflit.so
$(TARGETS):    $(FLIT_LIB_DIR)/libflit.so
endif # ifeq ($(UNAME_S),Darwin): meaning, we are on a mac

# include the build dependencies for gt and dev

-include $(GT_DEPS)
-include $(DEV_DEPS)

#
# Now for the compilation rules:
#

# Dev compilation rules first (easier to understand)
$(DEV_TARGET): $(DEV_OBJ) Makefile custom.mk
	$(DEV_CC) $(CC_REQUIRED) $(DEV_CFLAGS) \
	  -o $@ $(DEV_OBJ) $(LD_REQUIRED) $(DEV_LDFLAGS)

$(OBJ_DIR)/%_dev.o: %.cpp Makefile custom.mk | $(OBJ_DIR)
	$(DEV_CC) $(DEV_OPTL) $(DEV_SWITCHES) $(CC_REQUIRED) $(DEV_CFLAGS) $(DEPFLAGS) -c $< -o $@ \
	  -DFLIT_HOST='"$(HOSTNAME)"' \
	  -DFLIT_COMPILER='"$(DEV_CC)"' \
	  -DFLIT_OPTL='"$(DEV_OPTL)"' \
	  -DFLIT_SWITCHES='"$(DEV_SWITCHES)"' \
	  -DFLIT_FILENAME='"$(notdir $(DEV_TARGET))"'

# Ground truth compilation rules
$(GT_OUT): $(GT_TARGET)
	$(RUNWRAP) ./$(GT_TARGET) --output $(GT_OUT) --no-timing

$(GT_TARGET): $(GT_OBJ) Makefile custom.mk
	$(GT_CC) $(CC_REQUIRED) -o $@ $(GT_OBJ) $(LD_REQUIRED) $(GT_LDFLAGS)

$(OBJ_DIR)/%_gt.o: %.cpp Makefile custom.mk | $(OBJ_DIR)
	$(GT_CC) -g $(GT_OPTL) $(GT_SWITCHES) $(CC_REQUIRED) $(DEPFLAGS) -c $< -o $@ \
	  -DFLIT_HOST='"$(HOSTNAME)"' \
	  -DFLIT_COMPILER='"$(GT_CC)"' \
	  -DFLIT_OPTL='"$(GT_OPTL)"' \
	  -DFLIT_SWITCHES='"$(GT_SWITCHES)"' \
	  -DFLIT_FILENAME='"$(notdir $(GT_TARGET))"'

endif # end of ifdef R_IS_RECURSED

